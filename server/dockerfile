# Dockerfile (in server folder)
FROM node:20-alpine

# Install Python 3, FFmpeg, and create python symlink
RUN apk add --no-cache \
    python3 \
    py3-pip \
    ffmpeg \
    build-base \
    g++ \
    make && \
    # Create python symlink for yt-dlp
    ln -sf /usr/bin/python3 /usr/bin/python && \
    # Verify installations
    python --version && \
    ffmpeg -version

# Install yt-dlp (YouTube downloader)
RUN pip3 install --no-cache-dir yt-dlp==2024.11.11

WORKDIR /server

# Copy package files first (for better layer caching)
COPY package*.json ./

# Install Node.js dependencies
RUN npm ci --only=production

# Copy source code
COPY . .

# Build TypeScript
RUN npm run build

# Create temp directory for audio files
RUN mkdir -p /tmp/youtube-converter && \
    chmod 777 /tmp/youtube-converter

# Health check - using port 6969
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:6969/ || exit 1

EXPOSE 6969

# Run the application
CMD ["node", "dist/server.js"]
